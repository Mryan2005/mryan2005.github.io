const RightMenu=(()=>{const s=volantis.GLOBAL_CONFIG.plugins.rightmenu,d=volantis.GLOBAL_CONFIG.plugins.message.enable&&volantis.GLOBAL_CONFIG.plugins.message.rightmenu.enable,u={},m=document.getElementById("rightmenu-wrapper"),p=document.getElementById("rightmenu-content"),g=document.getElementById("printHtml"),y=document.getElementById("menuMusic"),M=document.getElementById("readingModel"),t=document.getElementById("read_bkg"),v=document.querySelectorAll(".menuLoad-Content"),o=document.querySelector(".menu-Option"),C=document.querySelector('.menu-Option[data-fn-type="searchWord"]'),O=document.querySelector('.menu-Option[data-fn-type="copyText"]'),b=document.querySelector('.menu-Option[data-fn-type="copyPaste"]'),h=document.querySelector('.menu-Option[data-fn-type="copySelect"]'),D=document.querySelector('.menu-Option[data-fn-type="copyCut"]'),S=document.querySelector('.menu-Option[data-fn-type="copyHref"]'),f=document.querySelector('.menu-Option[data-fn-type="copySrc"]'),w=document.querySelector('.menu-Option[data-fn-type="copyImg"]'),q=document.querySelector('.menu-Option[data-fn-type="openTab"]'),e=document.querySelector("#menuMusic .backward"),r=document.querySelector("#menuMusic .toggle"),n=document.querySelector("#menuMusic .forward"),_=/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;return u.init=()=>{DOMController.visible(y,!1),DOMController.visible(o,!1),t&&t.parentNode.removeChild(t);var e=document.createElement("div");e.className="common_read_bkg common_read_hide",e.id="read_bkg",window.document.body.appendChild(e)},u.initEvent=()=>{window.document.oncontextmenu=e=>e.ctrlKey||document.body.offsetWidth<=500?(u.hideMenu(),!0):u.popMenu(e),m.oncontextmenu=e=>(e.stopPropagation(),e.preventDefault(),!1),window.removeEventListener("blur",u.hideMenu),window.addEventListener("blur",u.hideMenu),document.body.removeEventListener("click",u.hideMenu),document.body.addEventListener("click",u.hideMenu),n&&r&&n&&(e.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerBackward()},r.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerToggle()},n.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerForward()})},u.popMenu=e=>{var t=e.clientX,o=e.clientY,r=document.documentElement.clientWidth||document.body.clientWidth,n=document.documentElement.clientHeight||document.body.clientHeight;try{u.setMenuItem(e),DOMController.visible(m),m.focus(),m.style.zIndex="-2147483648";var l=p.offsetWidth,i=p.offsetHeight,a=r<t+l?t-l+10:t,c=n<o+i?o-i+10:o,c=n<o+i&&c<i&&o<i?c+(n-i-c-10):c;m.style.left=a+"px",m.style.top=c+"px",m.style.zIndex="2147483648",volantis.GLOBAL_CONFIG.plugins.message.rightmenu.notice&&u.showMessage()}catch(e){return m.blur(),console.error(e),!0}return!1},u.showMessage=()=>{var e="true"===localStorage.getItem("NoticeRightMenu");d&&!e&&VolantisApp.message("右键菜单","唤醒原系统菜单请使用：<kbd>Ctrl</kbd> + <kbd>右键</kbd>",{icon:s.faicon+" fa-exclamation-square red",time:9e3},()=>{localStorage.setItem("NoticeRightMenu","true")})},u.setMenuItem=e=>{let t=!1;const o=e.target,r=window.getSelection().toString();if(DOMController.visible(q,!1),"input"===o.tagName.toLowerCase()||"textarea"===o.tagName.toLowerCase()){const c=o.value;0<c.length?(DOMController.visible(h),h.onclick=()=>{e.preventDefault(),o.select()}):DOMController.visible(h,!1),r?(DOMController.visible(D),D.onclick=()=>{var e=o.selectionStart,t=o.selectionEnd;u.copyString(r),o.value=c.substring(0,e)+c.substring(t,c.length),o.selectionStart=e,o.selectionEnd=e,o.focus()}):DOMController.visible(D,!1),u.readClipboard().then(e=>{e?(DOMController.visible(b),b.onclick=()=>{u.insertAtCaret(o,e)}):DOMController.visible(b,!1)}).catch(e=>{console.error(e),DOMController.visible(b,!1)})}else DOMController.visible(h,!1),DOMController.visible(b,!1),DOMController.visible(D,!1);const n=o.href,l=(n&&_.test(n)?(t=!0,DOMController.visible(S),DOMController.visible(q),S&&(S.onclick=()=>{u.copyString(n)}),q.onclick=()=>{window.open(n)}):DOMController.visible(S,!1),o.currentSrc);l&&_.test(l)?(t=!0,DOMController.visible(f),DOMController.visible(q),f.onclick=()=>{u.copyString(l)},q.onclick=()=>{window.open(l)}):DOMController.visible(f,!1),l&&_.test(l)&&l.trimEnd().endsWith(".png")?(t=!0,DOMController.visible(w),w.onclick=()=>{u.writeClipImg(e,e=>{e&&d&&VolantisApp.message("系统提示","图片复制成功！",{icon:s.faicon+" fa-images"})},e=>{d&&VolantisApp.message("系统提示","复制失败："+e,{icon:s.faicon+" fa-exclamation-square red"})})}):DOMController.visible(w,!1),r?(t=!0,DOMController.visible(O),DOMController.visible(C),O.onclick=()=>{u.copyString(r)},C&&(C.onclick=()=>{OpenSearch(r)})):(DOMController.visible(O,!1),DOMController.visible(C,!1));var i=document.querySelector("#post.article")||null;const a=window.location.pathname;i?(DOMController.visible(g),DOMController.visible(M),g&&(g.onclick=()=>{window.location.pathname===a?d&&VolantisApp.question("",'是否打印当前页面？<br><em style="font-size: 80%">建议打印时勾选背景图形</em><br>',{},()=>{u.printHtml()}):u.hideMenu()}),M&&(M.onclick=()=>{window.location.pathname,a,u.readingModel()})):(DOMController.visible(g,!1),DOMController.visible(M,!1)),volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&"undefined"!=typeof RightMenuAplayer&&void 0!==RightMenuAplayer.APlayer.player?s.music_alwaysShow?DOMController.visible(y):"play"===RightMenuAplayer.APlayer.status||"undefined"===RightMenuAplayer.APlayer.status?(t=!0,DOMController.visible(y)):DOMController.visible(y,!1):DOMController.visible(y,!1),v.forEach(e=>{DOMController.visible(e,!t)}),volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&s.layout.includes("music")&&RightMenuAplayer.checkAPlayer()},u.hideMenu=()=>{DOMController.visible(m,!1)},u.copyString=e=>{VolantisApp.utilWriteClipText(e).then(()=>{d&&VolantisApp.messageCopyright()}).catch(e=>{d&&VolantisApp.message("系统提示",e,{icon:s.faicon+" fa-exclamation-square red"})})},u.writeClipText=t=>{try{return navigator.clipboard.writeText(t).then(()=>Promise.resolve()).catch(e=>Promise.reject(e))}catch(e){var o=document.createElement("input");o.setAttribute("readonly","readonly"),document.body.appendChild(o),o.setAttribute("value",t),o.select();try{var r=document.execCommand("copy");return document.body.removeChild(o),r&&"unsuccessful"!==r?Promise.resolve():Promise.reject("复制文本失败!")}catch(e){return document.body.removeChild(o),Promise.reject("当前浏览器不支持复制功能，请检查更新或更换其他浏览器操作!")}}},u.writeClipImg=async function(t,o,r){var n=s.customPicUrl.enable?t.target.currentSrc.replace(s.customPicUrl.old,s.customPicUrl.new):t.target.currentSrc,t=t.target.parentElement;try{var e=await(await fetch(n)).blob();await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]).then(()=>{o(!0)},e=>{console.error("图片复制失败：",e),r(e)})}catch(e){var l,i,a,n=document;try{n.body.createTextRange?((l=document.body.createTextRange()).moveToElementText(t),l.select()):window.getSelection&&(i=window.getSelection(),(a=document.createRange()).selectNodeContents(t),i.removeAllRanges(),i.addRange(a)),document.execCommand("copy"),window.getSelection().removeAllRanges(),o(!1)}catch(e){console.error(e),r("不支持复制当前图片！")}}},u.readClipboard=async()=>{var e=await navigator.permissions.query({name:"clipboard-read"});return"granted"===e.state||"prompt"===e.state?navigator.clipboard.readText().then(e=>e).catch(e=>Promise.reject(e)):Promise.reject(e)},u.insertAtCaret=(e,t)=>{var o,r=e.selectionStart,n=e.selectionEnd;document.selection?(e.focus(),document.selection.createRange().text=t,e.focus()):r||"0"==r?(o=e.scrollTop,e.value=e.value.substring(0,r)+t+e.value.substring(n,e.value.length),e.focus(),e.selectionStart=r+t.length,e.selectionEnd=r+t.length,e.scrollTop=o):(e.value+=t,e.focus())},u.printHtml=()=>{volantis.isReadModel&&u.readingModel(),DOMController.setAttribute("details","open","true"),DOMController.remove(".cus-article-bkg"),DOMController.remove(".iziToast-overlay"),DOMController.remove(".iziToast-wrapper"),DOMController.remove(".prev-next"),DOMController.remove("footer"),DOMController.remove("#l_header"),DOMController.remove("#l_cover"),DOMController.remove("#l_side"),DOMController.remove("#comments"),DOMController.remove("#s-top"),DOMController.remove("#BKG"),DOMController.remove("#rightmenu-wrapper"),DOMController.remove(".nav-tabs"),DOMController.remove(".parallax-mirror"),DOMController.remove(".new-meta-item.share"),DOMController.remove("div.footer"),DOMController.setStyle("body","backgroundColor","unset"),DOMController.setStyle("#l_main","width","100%"),DOMController.setStyle("#post","boxShadow","none"),DOMController.setStyle("#post","background","none"),DOMController.setStyle("#post","padding","0"),DOMController.setStyle("h1","textAlign","center"),DOMController.setStyle("h1","fontWeight","600"),DOMController.setStyle("h1","fontSize","2rem"),DOMController.setStyle("h1","marginBottom","20px"),DOMController.setStyle(".tab-pane","display","block"),DOMController.setStyle(".tab-content","borderTop","none"),DOMController.setStyle(".highlight>table pre","whiteSpace","pre-wrap"),DOMController.setStyle(".highlight>table pre","wordBreak","break-all"),DOMController.setStyle(".fancybox img","height","auto"),DOMController.setStyle(".fancybox img","weight","auto"),setTimeout(()=>{window.print(),document.body.innerHTML="",window.location.reload()},50)},u.readingModel=()=>{var e;"function"==typeof ScrollReveal&&ScrollReveal().clean("#comments"),DOMController.fadeToggle(document.querySelector("#l_header")),DOMController.fadeToggle(document.querySelector("footer")),DOMController.fadeToggle(document.querySelector("#s-top")),DOMController.fadeToggle(document.querySelector(".article-meta#bottom")),DOMController.fadeToggle(document.querySelector(".prev-next")),DOMController.fadeToggle(document.querySelector("#l_side")),DOMController.fadeToggle(document.querySelector("#comments")),DOMController.toggleClass(document.querySelector("#l_main"),"common_read"),DOMController.toggleClass(document.querySelector("#l_main"),"common_read_main"),DOMController.toggleClass(document.querySelector("#l_body"),"common_read"),DOMController.toggleClass(document.querySelector("#safearea"),"common_read"),DOMController.toggleClass(document.querySelector("#pjax-container"),"common_read"),DOMController.toggleClass(document.querySelector("#read_bkg"),"common_read_hide"),DOMController.toggleClass(document.querySelector("h1"),"common_read_h1"),DOMController.toggleClass(document.querySelector("#post"),"post_read"),DOMController.toggleClass(document.querySelector("#l_cover"),"read_cover"),DOMController.toggleClass(document.querySelector(".widget.toc-wrapper"),"post_read"),volantis.isReadModel=void 0===volantis.isReadModel||!volantis.isReadModel,volantis.isReadModel?(e={backgroundColor:"var(--color-read-post)",icon:s.faicon+" fa-book-reader",time:5e3},d&&VolantisApp.message("系统提示","阅读模式已开启，您可以点击屏幕空白处退出。",e),document.querySelector("#l_body").removeEventListener("click",u.readingModel),document.querySelector("#l_body").addEventListener("click",e=>{DOMController.hasClass(e.target,"common_read")&&u.readingModel()})):(document.querySelector("#l_body").removeEventListener("click",u.readingModel),document.querySelector("#post").removeEventListener("click",u.readingModel))},{init:(e=!1)=>{u.init(),u.initEvent(),e&&d&&VolantisApp.message("系统提示","自定义右键注册成功。")},destroy:(e=!1)=>{u.hideMenu(),window.document.oncontextmenu=()=>!0,e&&d&&VolantisApp.message("系统提示","自定义右键注销成功。")},hideMenu:u.hideMenu,readingModel:u.readingModel}})();Object.freeze(RightMenu),volantis.requestAnimationFrame(()=>{"loading"!==document.readyState?(RightMenu.init(),volantis.pjax.send(()=>{RightMenu.hideMenu()})):document.addEventListener("DOMContentLoaded",function(){RightMenu.init(),volantis.pjax.send(()=>{RightMenu.hideMenu()})})});