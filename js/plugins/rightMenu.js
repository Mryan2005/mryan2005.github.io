const RightMenu=(()=>{const u=volantis.GLOBAL_CONFIG.plugins.rightmenu,s=volantis.GLOBAL_CONFIG.plugins.message.enable&&volantis.GLOBAL_CONFIG.plugins.message.rightmenu.enable;const d={},m=document.getElementById("rightmenu-wrapper"),p=document.getElementById("rightmenu-content"),g=document.getElementById("printHtml"),y=document.getElementById("menuMusic"),M=document.getElementById("readingModel"),t=document.getElementById("read_bkg");const f=document.querySelectorAll(".menuLoad-Content"),o=document.querySelector(".menu-Option"),C=document.querySelector('.menu-Option[data-fn-type="searchWord"]'),v=document.querySelector('.menu-Option[data-fn-type="copyText"]'),O=document.querySelector('.menu-Option[data-fn-type="copyPaste"]'),b=document.querySelector('.menu-Option[data-fn-type="copySelect"]'),h=document.querySelector('.menu-Option[data-fn-type="copyCut"]'),D=document.querySelector('.menu-Option[data-fn-type="copyHref"]'),S=document.querySelector('.menu-Option[data-fn-type="copySrc"]'),w=document.querySelector('.menu-Option[data-fn-type="copyImg"]'),q=document.querySelector('.menu-Option[data-fn-type="openTab"]'),e=document.querySelector("#menuMusic .backward"),l=document.querySelector("#menuMusic .toggle"),n=document.querySelector("#menuMusic .forward");const _=/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;d.init=()=>{DOMController.visible(y,false);DOMController.visible(o,false);if(t)t.parentNode.removeChild(t);const e=document.createElement("div");e.className="common_read_bkg common_read_hide";e.id="read_bkg";window.document.body.appendChild(e)};d.initEvent=()=>{window.document.oncontextmenu=e=>{if(e.ctrlKey||document.body.offsetWidth<=500){d.hideMenu();return true}return d.popMenu(e)};m.oncontextmenu=e=>{e.stopPropagation();e.preventDefault();return false};window.removeEventListener("blur",d.hideMenu);window.addEventListener("blur",d.hideMenu);document.body.removeEventListener("click",d.hideMenu);document.body.addEventListener("click",d.hideMenu);if(n&&l&&n){e.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerBackward()};l.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerToggle()};n.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerForward()}}};d.popMenu=n=>{let r=n.clientX;let i=n.clientY;let a=document.documentElement.clientWidth||document.body.clientWidth;let c=document.documentElement.clientHeight||document.body.clientHeight;try{d.setMenuItem(n);DOMController.visible(m);m.focus();m.style.zIndex="-2147483648";let e=p.offsetWidth;let t=p.offsetHeight;let o=r+e>a?r-e+10:r;let l=i+t>c?i-t+10:i;l=i+t>c&&l<t&&i<t?l+(c-t-l-10):l;m.style.left=o+"px";m.style.top=l+"px";m.style.zIndex="2147483648";if(volantis.GLOBAL_CONFIG.plugins.message.rightmenu.notice)d.showMessage()}catch(e){m.blur();console.error(e);return true}return false};d.showMessage=()=>{const e=localStorage.getItem("NoticeRightMenu")==="true";if(s&&!e)VolantisApp.message("右键菜单","唤醒原系统菜单请使用：<kbd>Ctrl</kbd> + <kbd>右键</kbd>",{icon:u.faicon+" fa-exclamation-square red",time:9e3},()=>{localStorage.setItem("NoticeRightMenu","true")})};d.setMenuItem=e=>{let t=false;const o=e.target;const l=window.getSelection().toString();DOMController.visible(q,false);if(o.tagName.toLowerCase()==="input"||o.tagName.toLowerCase()==="textarea"){const c=o.value;if(c.length>0){DOMController.visible(b);b.onclick=()=>{e.preventDefault();o.select()}}else{DOMController.visible(b,false)}if(l){DOMController.visible(h);h.onclick=()=>{const e=o.selectionStart;const t=o.selectionEnd;d.copyString(l);o.value=c.substring(0,e)+c.substring(t,c.length);o.selectionStart=e;o.selectionEnd=e;o.focus()}}else{DOMController.visible(h,false)}d.readClipboard().then(e=>{if(!!e){DOMController.visible(O);O.onclick=()=>{d.insertAtCaret(o,e)}}else{DOMController.visible(O,false)}}).catch(e=>{console.error(e);DOMController.visible(O,false)})}else{DOMController.visible(b,false);DOMController.visible(O,false);DOMController.visible(h,false)}const n=o.href;if(!!n&&_.test(n)){t=true;DOMController.visible(D);DOMController.visible(q);if(D)D.onclick=()=>{d.copyString(n)};q.onclick=()=>{window.open(n)}}else{DOMController.visible(D,false)}const r=o.currentSrc;if(!!r&&_.test(r)){t=true;DOMController.visible(S);DOMController.visible(q);S.onclick=()=>{d.copyString(r)};q.onclick=()=>{window.open(r)}}else{DOMController.visible(S,false)}if(!!r&&_.test(r)&&r.trimEnd().endsWith(".png")){t=true;DOMController.visible(w);w.onclick=()=>{d.writeClipImg(e,e=>{if(e&&s)VolantisApp.message("系统提示","图片复制成功！",{icon:u.faicon+" fa-images"})},e=>{if(s)VolantisApp.message("系统提示","复制失败："+e,{icon:u.faicon+" fa-exclamation-square red"})})}}else{DOMController.visible(w,false)}if(l){t=true;DOMController.visible(v);DOMController.visible(C);v.onclick=()=>{d.copyString(l)};!!C&&(C.onclick=()=>{OpenSearch(l)})}else{DOMController.visible(v,false);DOMController.visible(C,false)}const i=document.querySelector("#post.article")||null;const a=window.location.pathname;if(!!i){DOMController.visible(g);DOMController.visible(M);if(g){g.onclick=()=>{if(window.location.pathname===a){const e='是否打印当前页面？<br><em style="font-size: 80%">建议打印时勾选背景图形</em><br>';if(s)VolantisApp.question("",e,{},()=>{d.printHtml()})}else{d.hideMenu()}}}if(M){M.onclick=()=>{if(window.location.pathname===a){d.readingModel()}else{d.readingModel()}}}}else{DOMController.visible(g,false);DOMController.visible(M,false)}if(volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&typeof RightMenuAplayer!=="undefined"&&RightMenuAplayer.APlayer.player!==undefined){if(u.music_alwaysShow){DOMController.visible(y)}else if(RightMenuAplayer.APlayer.status==="play"||RightMenuAplayer.APlayer.status==="undefined"){t=true;DOMController.visible(y)}else{DOMController.visible(y,false)}}else{DOMController.visible(y,false)}f.forEach(e=>{DOMController.visible(e,!t)});if(volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&u.layout.includes("music")){RightMenuAplayer.checkAPlayer()}};d.hideMenu=()=>{DOMController.visible(m,false)};d.copyString=e=>{VolantisApp.utilWriteClipText(e).then(()=>{if(s){VolantisApp.messageCopyright()}}).catch(e=>{if(s){VolantisApp.message("系统提示",e,{icon:u.faicon+" fa-exclamation-square red"})}})};d.writeClipText=t=>{try{return navigator.clipboard.writeText(t).then(()=>{return Promise.resolve()}).catch(e=>{return Promise.reject(e)})}catch(e){const o=document.createElement("input");o.setAttribute("readonly","readonly");document.body.appendChild(o);o.setAttribute("value",t);o.select();try{let e=document.execCommand("copy");document.body.removeChild(o);if(!e||e==="unsuccessful"){return Promise.reject("复制文本失败!")}else{return Promise.resolve()}}catch(e){document.body.removeChild(o);return Promise.reject("当前浏览器不支持复制功能，请检查更新或更换其他浏览器操作!")}}};d.writeClipImg=async function(e,t,o){const l=u.customPicUrl.enable?e.target.currentSrc.replace(u.customPicUrl.old,u.customPicUrl.new):e.target.currentSrc;const n=e.target.parentElement;try{const r=await fetch(l);const i=await r.blob();await navigator.clipboard.write([new ClipboardItem({[i.type]:i})]).then(()=>{t(true)},e=>{console.error("图片复制失败：",e);o(e)})}catch(e){const a=document;try{if(a.body.createTextRange){const c=document.body.createTextRange();c.moveToElementText(n);c.select()}else if(window.getSelection){const s=window.getSelection();const d=document.createRange();d.selectNodeContents(n);s.removeAllRanges();s.addRange(d)}document.execCommand("copy");window.getSelection().removeAllRanges();t(false)}catch(e){console.error(e);o("不支持复制当前图片！")}}};d.readClipboard=async()=>{const e=await navigator.permissions.query({name:"clipboard-read"});if(e.state==="granted"||e.state==="prompt"){return navigator.clipboard.readText().then(e=>e).catch(e=>Promise.reject(e))}return Promise.reject(e)};d.insertAtCaret=(e,t)=>{const o=e.selectionStart,l=e.selectionEnd;if(document.selection){e.focus();var n=document.selection.createRange();n.text=t;e.focus()}else{if(o||o=="0"){var r=e.scrollTop;e.value=e.value.substring(0,o)+t+e.value.substring(l,e.value.length);e.focus();e.selectionStart=o+t.length;e.selectionEnd=o+t.length;e.scrollTop=r}else{e.value+=t;e.focus()}}};d.printHtml=()=>{if(volantis.isReadModel)d.readingModel();DOMController.setAttribute("details","open","true");DOMController.remove(".cus-article-bkg");DOMController.remove(".iziToast-overlay");DOMController.remove(".iziToast-wrapper");DOMController.remove(".prev-next");DOMController.remove("footer");DOMController.remove("#l_header");DOMController.remove("#l_cover");DOMController.remove("#l_side");DOMController.remove("#comments");DOMController.remove("#s-top");DOMController.remove("#BKG");DOMController.remove("#rightmenu-wrapper");DOMController.remove(".nav-tabs");DOMController.remove(".parallax-mirror");DOMController.remove(".new-meta-item.share");DOMController.remove("div.footer");DOMController.setStyle("body","backgroundColor","unset");DOMController.setStyle("#l_main","width","100%");DOMController.setStyle("#post","boxShadow","none");DOMController.setStyle("#post","background","none");DOMController.setStyle("#post","padding","0");DOMController.setStyle("h1","textAlign","center");DOMController.setStyle("h1","fontWeight","600");DOMController.setStyle("h1","fontSize","2rem");DOMController.setStyle("h1","marginBottom","20px");DOMController.setStyle(".tab-pane","display","block");DOMController.setStyle(".tab-content","borderTop","none");DOMController.setStyle(".highlight>table pre","whiteSpace","pre-wrap");DOMController.setStyle(".highlight>table pre","wordBreak","break-all");DOMController.setStyle(".fancybox img","height","auto");DOMController.setStyle(".fancybox img","weight","auto");setTimeout(()=>{window.print();document.body.innerHTML="";window.location.reload()},50)};d.readingModel=()=>{if(typeof ScrollReveal==="function")ScrollReveal().clean("#comments");DOMController.fadeToggle(document.querySelector("#l_header"));DOMController.fadeToggle(document.querySelector("footer"));DOMController.fadeToggle(document.querySelector("#s-top"));DOMController.fadeToggle(document.querySelector(".article-meta#bottom"));DOMController.fadeToggle(document.querySelector(".prev-next"));DOMController.fadeToggle(document.querySelector("#l_side"));DOMController.fadeToggle(document.querySelector("#comments"));DOMController.toggleClass(document.querySelector("#l_main"),"common_read");DOMController.toggleClass(document.querySelector("#l_main"),"common_read_main");DOMController.toggleClass(document.querySelector("#l_body"),"common_read");DOMController.toggleClass(document.querySelector("#safearea"),"common_read");DOMController.toggleClass(document.querySelector("#pjax-container"),"common_read");DOMController.toggleClass(document.querySelector("#read_bkg"),"common_read_hide");DOMController.toggleClass(document.querySelector("h1"),"common_read_h1");DOMController.toggleClass(document.querySelector("#post"),"post_read");DOMController.toggleClass(document.querySelector("#l_cover"),"read_cover");DOMController.toggleClass(document.querySelector(".widget.toc-wrapper"),"post_read");volantis.isReadModel=volantis.isReadModel===undefined?true:!volantis.isReadModel;if(volantis.isReadModel){const e={backgroundColor:"var(--color-read-post)",icon:u.faicon+" fa-book-reader",time:5e3};if(s)VolantisApp.message("系统提示","阅读模式已开启，您可以点击屏幕空白处退出。",e);document.querySelector("#l_body").removeEventListener("click",d.readingModel);document.querySelector("#l_body").addEventListener("click",e=>{if(DOMController.hasClass(e.target,"common_read")){d.readingModel()}})}else{document.querySelector("#l_body").removeEventListener("click",d.readingModel);document.querySelector("#post").removeEventListener("click",d.readingModel)}};return{init:(e=false)=>{d.init();d.initEvent();if(e&&s)VolantisApp.message("系统提示","自定义右键注册成功。")},destroy:(e=false)=>{d.hideMenu();window.document.oncontextmenu=()=>{return true};if(e&&s)VolantisApp.message("系统提示","自定义右键注销成功。")},hideMenu:d.hideMenu,readingModel:d.readingModel}})();Object.freeze(RightMenu);volantis.requestAnimationFrame(()=>{if(document.readyState!=="loading"){RightMenu.init();volantis.pjax.send(()=>{RightMenu.hideMenu()})}else{document.addEventListener("DOMContentLoaded",function(){RightMenu.init();volantis.pjax.send(()=>{RightMenu.hideMenu()})})}});