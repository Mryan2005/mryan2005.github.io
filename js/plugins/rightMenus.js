const RightMenus={defaultEvent:["copyText","copyLink","copyPaste","copyAll","copyCut","copyImg","printMode","readMode"],defaultGroup:["navigation","inputBox","seletctText","elementCheck","elementImage","articlePage"],messageRightMenu:volantis.GLOBAL_CONFIG.plugins.message.enable&&volantis.GLOBAL_CONFIG.plugins.message.rightmenu.enable,corsAnywhere:volantis.GLOBAL_CONFIG.plugins.rightmenus.options.corsAnywhere,urlRegx:/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/,imgRegx:/\.(jpe?g|png|webp|svg|gif|jifi)(-|_|!|\?|\/)?.*$/,initialMenu:()=>{RightMenus.fun.init();volantis.pjax.send(()=>{RightMenus.fun.hideMenu();if(volantis.isReadModel)RightMenus.fun.readMode()})},readClipboard:async()=>{let e;const t=await navigator.permissions.query({name:"clipboard-read"});switch(t.state){case"granted":case"prompt":e=await navigator.clipboard.readText();break;default:window.clipboardRead=false;break}return e},writeClipText:e=>{return navigator.clipboard.writeText(e).then(()=>{return Promise.resolve()}).catch(e=>{return Promise.reject(e)})},writeClipImg:async(e,n,i)=>{const o=new Image;o.crossOrigin="Anonymous";o.addEventListener("load",()=>{let e=document.createElement("canvas");let t=e.getContext("2d");e.width=o.width;e.height=o.height;t.drawImage(o,0,0);e.toBlob(e=>{navigator.clipboard.write([new ClipboardItem({"image/png":e})]).then(e=>{n(e)}).catch(e=>{i(e)})},"image/png")},false);o.src=`${e}?(lll￢ω￢)`},insertAtCaret:(e,t)=>{const n=e.selectionStart,i=e.selectionEnd;if(document.selection){e.focus();var o=document.selection.createRange();o.text=t;e.focus()}else{if(n||n=="0"){var a=e.scrollTop;e.value=e.value.substring(0,n)+t+e.value.substring(i,e.value.length);e.focus();e.selectionStart=n+t.length;e.selectionEnd=n+t.length;e.scrollTop=a}else{e.value+=t;e.focus()}}}};RightMenus.fun=(()=>{const o=volantis.GLOBAL_CONFIG.plugins.rightmenus;const c={},u=document.getElementById("rightmenu-wrapper"),d=document.getElementById("rightmenu-content"),n=document.querySelectorAll("#rightmenu-content li.menuLoad-Content"),i=document.querySelectorAll("#rightmenu-content li, #rightmenu-content hr, #menuMusic"),t=document.getElementById("read_bkg"),a=document.getElementById("menuMusic"),e=document.querySelector("#menuMusic .backward"),l=document.querySelector("#menuMusic .toggle"),s=document.querySelector("#menuMusic .forward");let r={mouseEvent:null,isInputBox:false,selectText:"",inputValue:"",isLink:false,linkUrl:"",isMediaLink:false,mediaLinkUrl:"",isImage:false,isArticle:false,pathName:"",isReadClipboard:true,isShowMusic:false,statusCheck:false};const m=Object.assign({},r);c.initEvent=()=>{c.elementAppend();c.contextmenu();c.menuEvent()};c.elementAppend=()=>{if(t)t.parentNode.removeChild(t);const e=document.createElement("div");e.className="common_read_bkg common_read_hide";e.id="read_bkg";window.document.body.appendChild(e)};c.menuPosition=r=>{try{let e=r.clientX;let t=r.clientY;let n=document.documentElement.clientWidth||document.body.clientWidth;let i=document.documentElement.clientHeight||document.body.clientHeight;u.style.display="block";c.menuControl(r);let o=d.offsetWidth;let a=d.offsetHeight;let l=e+o>n?e-o+10:e;let s=t+a>i?t-a+10:t;s=t+a>i&&s<a&&t<a?s+(i-a-s-10):s;u.style.left=`${l}px`;u.style.top=`${s}px`;if(volantis.GLOBAL_CONFIG.plugins.message.rightmenu.notice)c.menuNotic()}catch(e){console.error(e);c.hideMenu();return true}return false};c.menuControl=e=>{c.globalDataSet(e);if(!!a)a.style.display=r.isShowMusic?"block":"none";n.forEach(e=>{e.style.display="none";const t=e.firstElementChild.nodeName;const n=e.firstElementChild.getAttribute("data-group");const i=e.firstElementChild.getAttribute("data-event");if(r.statusCheck||r.isArticle){switch(n){case"inputBox":if(r.isInputBox){e.style.display="block";if(i==="copyCut"&&!r.selectText)e.style.display="none";if(i==="copyAll"&&!r.inputValue)e.style.display="none";if(i==="copyPaste"&&!r.isReadClipboard)e.style.display="none"}break;case"seletctText":if(!!r.selectText)e.style.display="block";break;case"elementCheck":if(r.isLink||r.isMediaLink)e.style.display="block";break;case"elementImage":if(r.isImage)e.style.display="block";break;case"articlePage":if(r.isArticle)e.style.display="block";break;default:e.style.display=t==="A"?r.isArticle&&!r.statusCheck&&o.options.articleShowLink?"block":"none":"block";break}}else if(t==="A"||RightMenus.defaultGroup.every(e=>{return n!==e})){e.style.display="block"}});volantis.mouseEvent=e;volantis.rightmenu.method.handle.start();let t={item:null,hide:true};i.forEach(e=>{if(e.nodeName==="HR"){e.style.display="block";if(!t.item){t.item=e;return}if(t.hide||t.item.nextElementSibling.nodeName==="hr"){t.item.style.display="none"}t.item=e;t.hide=true}else{if(e.style.display==="block"&&t.hide){t.hide=false}}});if(!!t.item&&t.hide)t.item.style.display="none"};c.globalDataSet=e=>{r=Object.assign({},m);r.mouseEvent=e;r.selectText=window.getSelection().toString();if(e.target.tagName.toLowerCase()==="input"||e.target.tagName.toLowerCase()==="textarea"){r.isInputBox=true;r.inputValue=e.target.value}if(r.isInputBox&&window.clipboardRead===false){r.isReadClipboard=false}if(!!e.target.href&&RightMenus.urlRegx.test(e.target.href)){r.isLink=true;r.linkUrl=e.target.href}if(!!e.target.currentSrc&&RightMenus.urlRegx.test(e.target.currentSrc)){r.isMediaLink=true;r.mediaLinkUrl=e.target.currentSrc}if(r.isMediaLink&&RightMenus.imgRegx.test(r.mediaLinkUrl)){r.isImage=true}if(!!(document.querySelector("#post.article")||null)){r.isArticle=true;r.pathName=window.location.pathname}if(volantis.GLOBAL_CONFIG.plugins.aplayer?.enable&&typeof RightMenuAplayer!=="undefined"&&RightMenuAplayer.APlayer.player!==undefined){if(o.options.musicAlwaysShow||RightMenuAplayer.APlayer.status==="play"||RightMenuAplayer.APlayer.status==="undefined"){r.isShowMusic=true}}if(!!r.selectText||r.isInputBox||r.isLink||r.isMediaLink){r.statusCheck=true}};c.contextmenu=()=>{window.document.oncontextmenu=e=>{if(e.ctrlKey||document.body.offsetWidth<=500){c.hideMenu();return true}return c.menuPosition(e)};u.oncontextmenu=e=>{e.stopPropagation();e.preventDefault();return false};window.removeEventListener("blur",c.hideMenu);window.addEventListener("blur",c.hideMenu);document.body.removeEventListener("click",c.hideMenu);document.body.addEventListener("click",c.hideMenu)};c.menuEvent=()=>{n.forEach(e=>{let t=e.firstElementChild.getAttribute("data-event");const n=e.firstElementChild.getAttribute("id");const i=e.firstElementChild.getAttribute("data-group");if(e.firstElementChild.nodeName==="A")return;e.addEventListener("click",()=>{try{if(RightMenus.defaultEvent.every(e=>{return t!==e})){if(i==="seletctText"){RightMenusFunction[n](r.selectText)}else if(i==="elementCheck"){RightMenusFunction[n](r.isLink?r.linkUrl:r.mediaLinkUrl)}else if(i==="elementImage"){RightMenusFunction[n](r.mediaLinkUrl)}else{RightMenusFunction[n]()}}else{c[t]()}}catch(e){if(volantis.GLOBAL_CONFIG.debug==="rightMenus"){console.error({id:n,error:e,globalData:r,groupName:i,eventName:t})}if(RightMenus.messageRightMenu){VolantisApp.message("错误提示",e,{icon:o.options.iconPrefix+" fa-exclamation-square red",time:"15000"})}}})});if(s&&l&&s){e.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerBackward()};l.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerToggle()};s.onclick=e=>{e.preventDefault();e.stopPropagation();RightMenuAplayer.aplayerForward()}}};c.hideMenu=()=>{u.style.display=null;u.style.left=null;u.style.top=null};c.menuNotic=()=>{const e=localStorage.getItem("NoticeRightMenu")==="true";if(RightMenus.messageRightMenu&&!e)VolantisApp.message("右键菜单","唤醒原系统菜单请使用：<kbd>Ctrl</kbd> + <kbd>右键</kbd>",{icon:o.options.iconPrefix+" fa-exclamation-square red",displayMode:1,time:9e3},()=>{localStorage.setItem("NoticeRightMenu","true")})};c.copyText=()=>{VolantisApp.utilWriteClipText(r.selectText).then(()=>{if(RightMenus.messageRightMenu){VolantisApp.messageCopyright()}}).catch(e=>{if(RightMenus.messageRightMenu){VolantisApp.message("系统提示",e,{icon:o.options.iconPrefix+" fa-exclamation-square red",displayMode:1,time:9e3})}})};c.copyLink=()=>{VolantisApp.utilWriteClipText(r.linkUrl||r.mediaLinkUrl).then(()=>{if(RightMenus.messageRightMenu){VolantisApp.messageCopyright()}}).catch(e=>{if(RightMenus.messageRightMenu){VolantisApp.message("系统提示",e,{icon:o.options.iconPrefix+" fa-exclamation-square red",displayMode:1,time:9e3})}})};c.copyAll=()=>{r.mouseEvent.target.select()};c.copyPaste=async()=>{const e=await RightMenus.readClipboard()||"";if(RightMenus.messageRightMenu&&window.clipboardRead===false){VolantisApp.message("系统提示","未授予剪切板读取权限！")}else if(RightMenus.messageRightMenu&&e===""){VolantisApp.message("系统提示","仅支持复制文本内容！")}else{RightMenus.insertAtCaret(r.mouseEvent.target,e)}};c.copyCut=()=>{const e=r.mouseEvent.target.selectionStart;const t=r.mouseEvent.target.selectionEnd;const n=r.inputValue;c.copyText(r.selectText);r.mouseEvent.target.value=n.substring(0,e)+n.substring(t,n.length);r.mouseEvent.target.selectionStart=e;r.mouseEvent.target.selectionEnd=e;r.mouseEvent.target.focus()};c.copyImg=()=>{if(volantis.GLOBAL_CONFIG.plugins.message.rightmenu.notice){VolantisApp.message("系统提示","复制中，请等待。",{icon:o.options.iconPrefix+" fa-images"})}RightMenus.writeClipImg(r.mediaLinkUrl,e=>{if(RightMenus.messageRightMenu){VolantisApp.hideMessage();VolantisApp.message("系统提示","图片复制成功！",{icon:o.options.iconPrefix+" fa-images"})}},e=>{console.error(e);if(RightMenus.messageRightMenu){VolantisApp.hideMessage();VolantisApp.message("系统提示","复制失败："+e,{icon:o.options.iconPrefix+" fa-exclamation-square red",time:9e3})}})};c.printMode=()=>{if(window.location.pathname===r.pathName){if(RightMenus.messageRightMenu){const e='是否打印当前页面？<br><em style="font-size: 80%">建议打印时勾选背景图形</em><br>';VolantisApp.question("",e,{time:9e3},()=>{c.printHtml()})}else{c.printHtml()}}};c.printHtml=()=>{if(volantis.isReadModel)c.readMode();DOMController.setAttribute("details","open","true");DOMController.removeList([".cus-article-bkg",".iziToast-overlay",".iziToast-wrapper",".prev-next","footer","#l_header","#l_cover","#l_side","#comments","#s-top","#BKG","#rightmenu-wrapper",".nav-tabs",".parallax-mirror",".new-meta-item.share","div.footer"]);DOMController.setStyleList([["body","backgroundColor","unset"],["#l_main","width","100%"],["#post","boxShadow","none"],["#post","background","none"],["#post","padding","0"],["h1","textAlign","center"],["h1","fontWeight","600"],["h1","fontSize","2rem"],["h1","marginBottom","20px"],[".tab-pane","display","block"],[".tab-content","borderTop","none"],[".highlight>table pre","whiteSpace","pre-wrap"],[".highlight>table pre","wordBreak","break-all"],[".fancybox img","height","auto"],[".fancybox img","weight","auto"]]);setTimeout(()=>{window.print();document.body.innerHTML="";window.location.reload()},50)};c.readMode=()=>{if(typeof ScrollReveal==="function")ScrollReveal().clean("#comments");DOMController.fadeToggleList([document.querySelector("#l_header"),document.querySelector("footer"),document.querySelector("#s-top"),document.querySelector(".article-meta#bottom"),document.querySelector(".prev-next"),document.querySelector("#l_side"),document.querySelector("#comments")]);DOMController.toggleClassList([[document.querySelector("#l_main"),"common_read"],[document.querySelector("#l_main"),"common_read_main"],[document.querySelector("#l_body"),"common_read"],[document.querySelector("#safearea"),"common_read"],[document.querySelector("#pjax-container"),"common_read"],[document.querySelector("#read_bkg"),"common_read_hide"],[document.querySelector("h1"),"common_read_h1"],[document.querySelector("#post"),"post_read"],[document.querySelector("#l_cover"),"read_cover"],[document.querySelector(".widget.toc-wrapper"),"post_read"]]);DOMController.setStyle(".copyright.license","margin","15px 0");volantis.isReadModel=volantis.isReadModel===undefined?true:!volantis.isReadModel;if(volantis.isReadModel){if(RightMenus.messageRightMenu)VolantisApp.message("系统提示","阅读模式已开启，您可以点击屏幕空白处退出。",{backgroundColor:"var(--color-read-post)",icon:o.options.iconPrefix+" fa-book-reader",displayMode:1,time:5e3});document.querySelector("#l_body").removeEventListener("click",c.readMode);document.querySelector("#l_body").addEventListener("click",e=>{if(DOMController.hasClass(e.target,"common_read")){c.readMode()}})}else{document.querySelector("#l_body").removeEventListener("click",c.readMode);document.querySelector("#post").removeEventListener("click",c.readMode);DOMController.setStyle(".prev-next","display","flex");DOMController.setStyle(".copyright.license","margin","15px -40px")}};return{init:c.initEvent,hideMenu:c.hideMenu,readMode:c.readMode}})();Object.freeze(RightMenus);volantis.requestAnimationFrame(()=>{if(document.readyState!=="loading"){RightMenus.initialMenu()}else{document.addEventListener("DOMContentLoaded",function(){RightMenus.initialMenu()})}});